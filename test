#!pip install python-quickbooks google-cloud-bigquery pandas

import json
from quickbooks.client import QuickBooks
from google.cloud import bigquery
from pandas import DataFrame

# --- 1. Load QBO Credentials ---
CONFIG_FILE = 'qbo_config.json'
with open(CONFIG_FILE, 'r') as f:
    config = json.load(f)

# --- 2. Authenticate and Refresh QBO Token (CRITICAL STEP) ---
qb_client = QuickBooks(
    consumer_key=config['ABa2KRLhlpfCQtSj102PYYjsCNHBfgDX3KvStIiNqR6RCDjMgE'],
    consumer_secret=config['MDUFw1Osk1Ck5HIyS6KLZZZeqW8Fcv5k1y5IFSTt'],
    access_token=None,  
    company_id=config['1442 2336 00'],
    refresh_token=config['refresh_token'],
    sandbox=False,
    minorversion=65
)

try:
    # This gets a new Access Token and might provide a new Refresh Token
    qb_client.refresh_access_token() 
    
    # Save the new Refresh Token back to the file (essential for future runs)
    new_refresh_token = qb_client.refresh_token
    if new_refresh_token != config['refresh_token']:
        config['refresh_token'] = new_refresh_token
        with open(CONFIG_FILE, 'w') as f:
            json.dump(config, f, indent=4)
        print("✅ New Refresh Token saved.")

except Exception as e:
    print(f"❌ QBO Authentication Failed: {e}")
    # Stop here if QBO authentication fails
    raise

# --- 3. Authenticate BigQuery ---
# Use the Service Account JSON key path directly (most reliable)
BQ_KEY_PATH = 'bq_key.json' 
bq_client = bigquery.Client.from_service_account_json(BQ_KEY_PATH)

print("✅ All clients initialized.")

